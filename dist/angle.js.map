{"version":3,"file":"angle.js","sources":["../src/cfns.js","../src/capture.js","../src/angle.js"],"sourcesContent":["\r\n// 是 HTMLElement 节点\r\nexport function isElement(tar) {\r\n  return tar instanceof HTMLElement\r\n}\r\n\r\nexport function isNode(tar) {\r\n  return tar instanceof Node\r\n}\r\n\r\n// 获取指定目标的数据类型\r\nexport function type(tar) {\r\n  return Object.prototype.toString.call(tar).match(/\\s([a-zA-Z]+)/)[1].toLowerCase()\r\n}\r\n\r\n// 兼容出来 String.prototype.padStart\r\nexport function padStart(tar, length, padString = '') {\r\n  tar = `${tar}`\r\n  if (''.padStart) {\r\n    return tar.padStart(length, padString)\r\n  }\r\n  return tar.length > length ? tar : `${Array(length).join(padString)}${tar}`.slice(-length)\r\n} ","\r\nfunction createPropertyDescriptor() {\r\n  let data = null\r\n  return {\r\n    configurable: true,\r\n    enumerable: true,\r\n    get: function() {\r\n      return data\r\n    },\r\n    set: function(val) {\r\n      data = val\r\n      return data\r\n    }\r\n  }\r\n}\r\n\r\n// 生成缓存 hook 的键名\r\nfunction getHookName(name) {\r\n  return {\r\n    before: `${name}BeforeHook`,\r\n    after: `${name}AfterHook`\r\n  }\r\n}\r\n\r\nlet hooks = new WeakMap()\r\n\r\nfunction getHookCache(tar, name) {\r\n  if (!hooks.has(tar)) {\r\n    hooks.set(tar, {})\r\n  }\r\n  let { before, after } = getHookName(name)\r\n  let hook = hooks.get(tar)\r\n  if (!hook[before]) {\r\n    hook[before] = []\r\n  }\r\n  if (!hook[after]) {\r\n    hook[after] = []\r\n  }\r\n  return {\r\n    before: hook[before],\r\n    after: hook[after]\r\n  }\r\n}\r\n\r\n// 劫持原型链，重写/定义 HTMLElement 的某个属性\r\nfunction hijackProperty(tar, name) {\r\n  \r\n  // 如果已经被重写过\r\n  if (Reflect.getOwnPropertyDescriptor(tar, name)) {\r\n    return false\r\n  }\r\n  \r\n  let { before, after } = getHookCache(tar, name)\r\n  \r\n  let { configurable, enumerable, get, set } = Reflect.getOwnPropertyDescriptor(tar.__proto__, name) || createPropertyDescriptor()\r\n  \r\n  Reflect.defineProperty(tar, name, {\r\n    configurable,\r\n    enumerable,\r\n    get: function() {\r\n      return get.call(tar)\r\n    },\r\n    set: function(val) {\r\n      // 前置回调\r\n      val = before.reduce(function(pre, fn) {\r\n        return fn.call(tar, pre) || pre\r\n      }, val)\r\n      \r\n      set.call(tar, val)\r\n\r\n      // 后置回调\r\n      after.reduce(function(pre, fn) {\r\n        return fn.call(tar, pre) || pre\r\n      }, val)\r\n    }\r\n  })\r\n  \r\n  return { before, after }\r\n}\r\n\r\n// 从数组中删除某个元素\r\nfunction splice(arr, tar) {\r\n  let i = arr.indexOf(tar)\r\n  if (i != -1) {\r\n    arr.splice(i, 1)\r\n  }\r\n}\r\n\r\n/**\r\n * 劫持原型链属性并添加 hook function\r\n * @param {HTMLElement} tar\r\n * @param {String} name - 属性名\r\n * @param {Function} fn - hook function\r\n * @param {String} type - before/after  \r\n */\r\nexport function addHook(tar, name, fn, type = 'after') {\r\n  let { before, after } = hijackProperty(tar, name) || getHookCache(tar, name)\r\n  switch(type) {\r\n    case 'before':\r\n      splice(before, fn)\r\n      before.push(fn)\r\n      break\r\n    default:\r\n      splice(after, fn)\r\n      after.push(fn)\r\n      break\r\n  }\r\n}\r\n\r\n/**\r\n * 删除 hook function\r\n * @param {HTMLElement} tar\r\n * @param {String} name - 属性名\r\n * @param {Function} fn - hook function\r\n * @param {String} type - before/after  \r\n */\r\nexport function removeHook(tar, name, fn, type = 'after') {\r\n  let { before, after } = getHookCache(tar, name)\r\n  switch(type) {\r\n    case 'before':\r\n      splice(before, fn)\r\n      break\r\n    default:\r\n      splice(after, fn)\r\n      break\r\n  }\r\n}","import { isElement } from './cfns.js'\r\n\r\nimport { addHook } from './capture.js'\r\n\r\n/**\r\n * 监控输入，将全角标点转换为半角标点\r\n * @param {HTMLElement|selector} tar - 需要被绑定的 HTMLElement 对象或 HTMLElement 对象选择器\r\n */\r\nexport default function angle(tar) {\r\n  if (typeof tar === 'string') {\r\n    tar = document.querySelector(tar)\r\n  }\r\n  \r\n  if (!isElement(tar)) {\r\n    throw new Error('无效的 HTMLElement 节点')\r\n  }\r\n  \r\n  let name\r\n  \r\n  switch (tar.nodeName.toLowerCase()) {\r\n    case 'input':\r\n      name = 'value'\r\n      break\r\n    default:\r\n      name = 'textContent'\r\n      break\r\n  }\r\n  \r\n  tar.addEventListener('beforeinput', function(e) {\r\n    e.preventDefault()\r\n    e.inputType == 'insertText' && (tar[name] = `${tar[name]}${e.data}`)\r\n  })\r\n  \r\n  // 这一层的作用是劫持原型链的 getter/setter，即使通过 js 赋值也能进行监听\r\n  addHook(tar, name, function(value) {\r\n    let code, char = /[\\uff00-\\uffff\\u3000]/g.exec(value)\r\n    while (char) {\r\n      code = char[0].charCodeAt()\r\n      if (code == 12288) {\r\n        code = 32\r\n      }\r\n      if (code >= 65281 && code <= 65374) {\r\n        code = code - 65248\r\n      }\r\n      value = value.replace(new RegExp(char[0], 'gi'), String.fromCharCode(code))\r\n      char = /[\\uff00-\\uffff\\u3000]/g.exec(value)\r\n    }\r\n    return value\r\n  }, 'before')\r\n}\n"],"names":["isElement","tar","HTMLElement","createPropertyDescriptor","data","configurable","enumerable","get","set","val","getHookName","name","before","after","hooks","WeakMap","getHookCache","has","hook","hijackProperty","Reflect","getOwnPropertyDescriptor","__proto__","defineProperty","call","reduce","pre","fn","splice","arr","i","indexOf","addHook","type","push","angle","document","querySelector","Error","nodeName","toLowerCase","addEventListener","e","preventDefault","inputType","value","code","char","exec","charCodeAt","replace","RegExp","String","fromCharCode"],"mappings":"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"}