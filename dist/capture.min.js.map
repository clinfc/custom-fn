{"version":3,"file":"capture.min.js","sources":["../src/capture.js"],"sourcesContent":["\r\nfunction createPropertyDescriptor() {\r\n  let data = null\r\n  return {\r\n    configurable: true,\r\n    enumerable: true,\r\n    get: function() {\r\n      return data\r\n    },\r\n    set: function(val) {\r\n      data = val\r\n      return data\r\n    }\r\n  }\r\n}\r\n\r\n// 生成缓存 hook 的键名\r\nfunction getHookName(name) {\r\n  return {\r\n    before: `${name}BeforeHook`,\r\n    after: `${name}AfterHook`\r\n  }\r\n}\r\n\r\nlet hooks = new WeakMap()\r\n\r\nfunction getHookCache(tar, name) {\r\n  if (!hooks.has(tar)) {\r\n    hooks.set(tar, {})\r\n  }\r\n  let { before, after } = getHookName(name)\r\n  let hook = hooks.get(tar)\r\n  if (!hook[before]) {\r\n    hook[before] = []\r\n  }\r\n  if (!hook[after]) {\r\n    hook[after] = []\r\n  }\r\n  return {\r\n    before: hook[before],\r\n    after: hook[after]\r\n  }\r\n}\r\n\r\n// 劫持原型链，重写/定义 HTMLElement 的某个属性\r\nfunction hijackProperty(tar, name) {\r\n  \r\n  // 如果已经被重写过\r\n  if (Reflect.getOwnPropertyDescriptor(tar, name)) {\r\n    return false\r\n  }\r\n  \r\n  let { before, after } = getHookCache(tar, name)\r\n  \r\n  let { configurable, enumerable, get, set } = Reflect.getOwnPropertyDescriptor(tar.__proto__, name) || createPropertyDescriptor()\r\n  \r\n  Reflect.defineProperty(tar, name, {\r\n    configurable,\r\n    enumerable,\r\n    get: function() {\r\n      return get.call(tar)\r\n    },\r\n    set: function(val) {\r\n      // 前置回调\r\n      val = before.reduce(function(pre, fn) {\r\n        return fn.call(tar, pre) || pre\r\n      }, val)\r\n      \r\n      set.call(tar, val)\r\n\r\n      // 后置回调\r\n      after.reduce(function(pre, fn) {\r\n        return fn.call(tar, pre) || pre\r\n      }, val)\r\n    }\r\n  })\r\n  \r\n  return { before, after }\r\n}\r\n\r\n// 从数组中删除某个元素\r\nfunction splice(arr, tar) {\r\n  let i = arr.indexOf(tar)\r\n  if (i != -1) {\r\n    arr.splice(i, 1)\r\n  }\r\n}\r\n\r\n/**\r\n * 劫持原型链属性并添加 hook function\r\n * @param {HTMLElement} tar\r\n * @param {String} name - 属性名\r\n * @param {Function} fn - hook function\r\n * @param {String} type - before/after  \r\n */\r\nexport function addHook(tar, name, fn, type = 'after') {\r\n  let { before, after } = hijackProperty(tar, name) || getHookCache(tar, name)\r\n  switch(type) {\r\n    case 'before':\r\n      splice(before, fn)\r\n      before.push(fn)\r\n      break\r\n    default:\r\n      splice(after, fn)\r\n      after.push(fn)\r\n      break\r\n  }\r\n}\r\n\r\n/**\r\n * 删除 hook function\r\n * @param {HTMLElement} tar\r\n * @param {String} name - 属性名\r\n * @param {Function} fn - hook function\r\n * @param {String} type - before/after  \r\n */\r\nexport function removeHook(tar, name, fn, type = 'after') {\r\n  let { before, after } = getHookCache(tar, name)\r\n  switch(type) {\r\n    case 'before':\r\n      splice(before, fn)\r\n      break\r\n    default:\r\n      splice(after, fn)\r\n      break\r\n  }\r\n}"],"names":["hooks","WeakMap","getHookCache","tar","name","has","set","before","after","getHookName","hook","get","hijackProperty","Reflect","getOwnPropertyDescriptor","configurable","enumerable","__proto__","data","val","createPropertyDescriptor","defineProperty","call","reduce","pre","fn","splice","arr","i","indexOf","type","push"],"mappings":"sVAwBA,IAAIA,EAAQ,IAAIC,QAEhB,SAASC,EAAaC,EAAKC,GACpBJ,EAAMK,IAAIF,IACbH,EAAMM,IAAIH,EAAK,QAEbI,OAAEA,EAAFC,MAAUA,GAbhB,SAAqBJ,SACZ,CACLG,iBAAWH,gBACXI,gBAAUJ,gBAUYK,CAAYL,GAChCM,EAAOV,EAAMW,IAAIR,UAChBO,EAAKH,KACRG,EAAKH,GAAU,IAEZG,EAAKF,KACRE,EAAKF,GAAS,IAET,CACLD,OAAQG,EAAKH,GACbC,MAAOE,EAAKF,IAKhB,SAASI,EAAeT,EAAKC,MAGvBS,QAAQC,yBAAyBX,EAAKC,UACjC,MAGLG,OAAEA,EAAFC,MAAUA,GAAUN,EAAaC,EAAKC,IAEtCW,aAAEA,EAAFC,WAAgBA,EAAYL,IAAAA,EAAKL,IAAAA,GAAQO,QAAQC,yBAAyBX,EAAIc,UAAWb,IArD/F,eACMc,EAAO,WACJ,CACLH,cAAc,EACdC,YAAY,EACZL,IAAK,kBACIO,GAETZ,IAAK,SAASa,UACZD,EAAOC,EACAD,IA2C2FE,UAEtGP,QAAQQ,eAAelB,EAAKC,EAAM,CAChCW,aAAAA,EACAC,WAAAA,EACAL,IAAK,kBACIA,EAAIW,KAAKnB,IAElBG,IAAK,SAASa,GAEZA,EAAMZ,EAAOgB,QAAO,SAASC,EAAKC,UACzBA,EAAGH,KAAKnB,EAAKqB,IAAQA,IAC3BL,GAEHb,EAAIgB,KAAKnB,EAAKgB,GAGdX,EAAMe,QAAO,SAASC,EAAKC,UAClBA,EAAGH,KAAKnB,EAAKqB,IAAQA,IAC3BL,MAIA,CAAEZ,OAAAA,EAAQC,MAAAA,GAInB,SAASkB,EAAOC,EAAKxB,OACfyB,EAAID,EAAIE,QAAQ1B,IACV,GAANyB,GACFD,EAAID,OAAOE,EAAG,aAWX,SAAiBzB,EAAKC,EAAMqB,OAAIK,yDAAO,SACxCvB,OAAEA,EAAFC,MAAUA,GAAUI,EAAeT,EAAKC,IAASF,EAAaC,EAAKC,UAChE0B,OACA,SACHJ,EAAOnB,EAAQkB,GACflB,EAAOwB,KAAKN,iBAGZC,EAAOlB,EAAOiB,GACdjB,EAAMuB,KAAKN,kBAYV,SAAoBtB,EAAKC,EAAMqB,OAAIK,yDAAO,SAC3CvB,OAAEA,EAAFC,MAAUA,GAAUN,EAAaC,EAAKC,UACnC0B,OACA,SACHJ,EAAOnB,EAAQkB,iBAGfC,EAAOlB,EAAOiB"}