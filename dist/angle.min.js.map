{"version":3,"file":"angle.min.js","sources":["../src/capture.js","../src/angle.js","../src/cfns.js"],"sourcesContent":["\r\nfunction createPropertyDescriptor() {\r\n  let data = null\r\n  return {\r\n    configurable: true,\r\n    enumerable: true,\r\n    get: function() {\r\n      return data\r\n    },\r\n    set: function(val) {\r\n      data = val\r\n      return data\r\n    }\r\n  }\r\n}\r\n\r\n// 生成缓存 hook 的键名\r\nfunction getHookName(name) {\r\n  return {\r\n    before: `${name}BeforeHook`,\r\n    after: `${name}AfterHook`\r\n  }\r\n}\r\n\r\nlet hooks = new WeakMap()\r\n\r\nfunction getHookCache(tar, name) {\r\n  if (!hooks.has(tar)) {\r\n    hooks.set(tar, {})\r\n  }\r\n  let { before, after } = getHookName(name)\r\n  let hook = hooks.get(tar)\r\n  if (!hook[before]) {\r\n    hook[before] = []\r\n  }\r\n  if (!hook[after]) {\r\n    hook[after] = []\r\n  }\r\n  return {\r\n    before: hook[before],\r\n    after: hook[after]\r\n  }\r\n}\r\n\r\n// 劫持原型链，重写/定义 HTMLElement 的某个属性\r\nfunction hijackProperty(tar, name) {\r\n  \r\n  // 如果已经被重写过\r\n  if (Reflect.getOwnPropertyDescriptor(tar, name)) {\r\n    return false\r\n  }\r\n  \r\n  let { before, after } = getHookCache(tar, name)\r\n  \r\n  let { configurable, enumerable, get, set } = Reflect.getOwnPropertyDescriptor(tar.__proto__, name) || createPropertyDescriptor()\r\n  \r\n  Reflect.defineProperty(tar, name, {\r\n    configurable,\r\n    enumerable,\r\n    get: function() {\r\n      return get.call(tar)\r\n    },\r\n    set: function(val) {\r\n      // 前置回调\r\n      val = before.reduce(function(pre, fn) {\r\n        return fn.call(tar, pre) || pre\r\n      }, val)\r\n      \r\n      set.call(tar, val)\r\n\r\n      // 后置回调\r\n      after.reduce(function(pre, fn) {\r\n        return fn.call(tar, pre) || pre\r\n      }, val)\r\n    }\r\n  })\r\n  \r\n  return { before, after }\r\n}\r\n\r\n// 从数组中删除某个元素\r\nfunction splice(arr, tar) {\r\n  let i = arr.indexOf(tar)\r\n  if (i != -1) {\r\n    arr.splice(i, 1)\r\n  }\r\n}\r\n\r\n/**\r\n * 劫持原型链属性并添加 hook function\r\n * @param {HTMLElement} tar\r\n * @param {String} name - 属性名\r\n * @param {Function} fn - hook function\r\n * @param {String} type - before/after  \r\n */\r\nexport function addHook(tar, name, fn, type = 'after') {\r\n  let { before, after } = hijackProperty(tar, name) || getHookCache(tar, name)\r\n  switch(type) {\r\n    case 'before':\r\n      splice(before, fn)\r\n      before.push(fn)\r\n      break\r\n    default:\r\n      splice(after, fn)\r\n      after.push(fn)\r\n      break\r\n  }\r\n}\r\n\r\n/**\r\n * 删除 hook function\r\n * @param {HTMLElement} tar\r\n * @param {String} name - 属性名\r\n * @param {Function} fn - hook function\r\n * @param {String} type - before/after  \r\n */\r\nexport function removeHook(tar, name, fn, type = 'after') {\r\n  let { before, after } = getHookCache(tar, name)\r\n  switch(type) {\r\n    case 'before':\r\n      splice(before, fn)\r\n      break\r\n    default:\r\n      splice(after, fn)\r\n      break\r\n  }\r\n}","import { isElement } from './cfns.js'\r\n\r\nimport { addHook } from './capture.js'\r\n\r\n/**\r\n * 监控输入，将全角标点转换为半角标点\r\n * @param {HTMLElement|selector} tar - 需要被绑定的 HTMLElement 对象或 HTMLElement 对象选择器\r\n */\r\nexport default function angle(tar) {\r\n  if (typeof tar === 'string') {\r\n    tar = document.querySelector(tar)\r\n  }\r\n  \r\n  if (!isElement(tar)) {\r\n    throw new Error('无效的 HTMLElement 节点')\r\n  }\r\n  \r\n  let name\r\n  \r\n  switch (tar.nodeName.toLowerCase()) {\r\n    case 'input':\r\n      name = 'value'\r\n      break\r\n    default:\r\n      name = 'textContent'\r\n      break\r\n  }\r\n  \r\n  tar.addEventListener('beforeinput', function(e) {\r\n    e.preventDefault()\r\n    e.inputType == 'insertText' && (tar[name] = `${tar[name]}${e.data}`)\r\n  })\r\n  \r\n  // 这一层的作用是劫持原型链的 getter/setter，即使通过 js 赋值也能进行监听\r\n  addHook(tar, name, function(value) {\r\n    let code, char = /[\\uff00-\\uffff\\u3000]/g.exec(value)\r\n    while (char) {\r\n      code = char[0].charCodeAt()\r\n      if (code == 12288) {\r\n        code = 32\r\n      }\r\n      if (code >= 65281 && code <= 65374) {\r\n        code = code - 65248\r\n      }\r\n      value = value.replace(new RegExp(char[0], 'gi'), String.fromCharCode(code))\r\n      char = /[\\uff00-\\uffff\\u3000]/g.exec(value)\r\n    }\r\n    return value\r\n  }, 'before')\r\n}\n","\r\n// 是 HTMLElement 节点\r\nexport function isElement(tar) {\r\n  return tar instanceof HTMLElement\r\n}\r\n\r\nexport function isNode(tar) {\r\n  return tar instanceof Node\r\n}\r\n\r\n// 获取指定目标的数据类型\r\nexport function type(tar) {\r\n  return Object.prototype.toString.call(tar).match(/\\s([a-zA-Z]+)/)[1].toLowerCase()\r\n}\r\n\r\n// 兼容出来 String.prototype.padStart\r\nexport function padStart(tar, length, padString = '') {\r\n  tar = `${tar}`\r\n  if (''.padStart) {\r\n    return tar.padStart(length, padString)\r\n  }\r\n  return tar.length > length ? tar : `${Array(length).join(padString)}${tar}`.slice(-length)\r\n} "],"names":["hooks","WeakMap","getHookCache","tar","name","has","set","before","after","getHookName","hook","get","hijackProperty","Reflect","getOwnPropertyDescriptor","configurable","enumerable","__proto__","data","val","createPropertyDescriptor","defineProperty","call","reduce","pre","fn","splice","arr","i","indexOf","document","querySelector","HTMLElement","isElement","Error","nodeName","toLowerCase","addEventListener","e","preventDefault","inputType","type","push","addHook","value","code","char","exec","charCodeAt","replace","RegExp","String","fromCharCode"],"mappings":"gqBAwBA,IAAIA,EAAQ,IAAIC,QAEhB,SAASC,EAAaC,EAAKC,GACpBJ,EAAMK,IAAIF,IACbH,EAAMM,IAAIH,EAAK,QAEbI,OAAEA,EAAFC,MAAUA,GAbhB,SAAqBJ,SACZ,CACLG,iBAAWH,gBACXI,gBAAUJ,gBAUYK,CAAYL,GAChCM,EAAOV,EAAMW,IAAIR,UAChBO,EAAKH,KACRG,EAAKH,GAAU,IAEZG,EAAKF,KACRE,EAAKF,GAAS,IAET,CACLD,OAAQG,EAAKH,GACbC,MAAOE,EAAKF,IAKhB,SAASI,EAAeT,EAAKC,MAGvBS,QAAQC,yBAAyBX,EAAKC,UACjC,MAGLG,OAAEA,EAAFC,MAAUA,GAAUN,EAAaC,EAAKC,IAEtCW,aAAEA,EAAFC,WAAgBA,EAAYL,IAAAA,EAAKL,IAAAA,GAAQO,QAAQC,yBAAyBX,EAAIc,UAAWb,IArD/F,eACMc,EAAO,WACJ,CACLH,cAAc,EACdC,YAAY,EACZL,IAAK,kBACIO,GAETZ,IAAK,SAASa,UACZD,EAAOC,EACAD,IA2C2FE,UAEtGP,QAAQQ,eAAelB,EAAKC,EAAM,CAChCW,aAAAA,EACAC,WAAAA,EACAL,IAAK,kBACIA,EAAIW,KAAKnB,IAElBG,IAAK,SAASa,GAEZA,EAAMZ,EAAOgB,QAAO,SAASC,EAAKC,UACzBA,EAAGH,KAAKnB,EAAKqB,IAAQA,IAC3BL,GAEHb,EAAIgB,KAAKnB,EAAKgB,GAGdX,EAAMe,QAAO,SAASC,EAAKC,UAClBA,EAAGH,KAAKnB,EAAKqB,IAAQA,IAC3BL,MAIA,CAAEZ,OAAAA,EAAQC,MAAAA,GAInB,SAASkB,EAAOC,EAAKxB,OACfyB,EAAID,EAAIE,QAAQ1B,IACV,GAANyB,GACFD,EAAID,OAAOE,EAAG,aC5EH,SAAezB,MACT,iBAARA,IACTA,EAAM2B,SAASC,cAAc5B,KCR1B,SAAmBA,UACjBA,aAAe6B,YDUjBC,CAAU9B,SACP,IAAI+B,MAAM,0BAGd9B,SAEID,EAAIgC,SAASC,mBACd,QACHhC,EAAO,sBAGPA,EAAO,cAIXD,EAAIkC,iBAAiB,eAAe,SAASC,GAC3CA,EAAEC,iBACa,cAAfD,EAAEE,YAA8BrC,EAAIC,aAAWD,EAAIC,WAAQkC,EAAEpB,UDiE1D,SAAiBf,EAAKC,EAAMqB,OAAIgB,yDAAO,SACxClC,OAAEA,EAAFC,MAAUA,GAAUI,EAAeT,EAAKC,IAASF,EAAaC,EAAKC,UAChEqC,OACA,SACHf,EAAOnB,EAAQkB,GACflB,EAAOmC,KAAKjB,iBAGZC,EAAOlB,EAAOiB,GACdjB,EAAMkC,KAAKjB,ICtEfkB,CAAQxC,EAAKC,GAAM,SAASwC,OACtBC,EAAMC,EAAO,yBAAyBC,KAAKH,QACxCE,GACLD,EAAOC,EAAK,GAAGE,aACH,OAARH,IACFA,EAAO,IAELA,GAAQ,OAASA,GAAQ,QAC3BA,GAAc,OAEhBD,EAAQA,EAAMK,QAAQ,IAAIC,OAAOJ,EAAK,GAAI,MAAOK,OAAOC,aAAaP,IACrEC,EAAO,yBAAyBC,KAAKH,UAEhCA,IACN"}