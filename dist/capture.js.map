{"version":3,"file":"capture.js","sources":["../src/capture.js"],"sourcesContent":["\r\nfunction createPropertyDescriptor() {\r\n  let data = null\r\n  return {\r\n    configurable: true,\r\n    enumerable: true,\r\n    get: function() {\r\n      return data\r\n    },\r\n    set: function(val) {\r\n      data = val\r\n      return data\r\n    }\r\n  }\r\n}\r\n\r\n// 生成缓存 hook 的键名\r\nfunction getHookName(name) {\r\n  return {\r\n    before: `${name}BeforeHook`,\r\n    after: `${name}AfterHook`\r\n  }\r\n}\r\n\r\nlet hooks = new WeakMap()\r\n\r\nfunction getHookCache(tar, name) {\r\n  if (!hooks.has(tar)) {\r\n    hooks.set(tar, {})\r\n  }\r\n  let { before, after } = getHookName(name)\r\n  let hook = hooks.get(tar)\r\n  if (!hook[before]) {\r\n    hook[before] = []\r\n  }\r\n  if (!hook[after]) {\r\n    hook[after] = []\r\n  }\r\n  return {\r\n    before: hook[before],\r\n    after: hook[after]\r\n  }\r\n}\r\n\r\n// 劫持原型链，重写/定义 HTMLElement 的某个属性\r\nfunction hijackProperty(tar, name) {\r\n  \r\n  // 如果已经被重写过\r\n  if (Reflect.getOwnPropertyDescriptor(tar, name)) {\r\n    return false\r\n  }\r\n  \r\n  let { before, after } = getHookCache(tar, name)\r\n  \r\n  let { configurable, enumerable, get, set } = Reflect.getOwnPropertyDescriptor(tar.__proto__, name) || createPropertyDescriptor()\r\n  \r\n  Reflect.defineProperty(tar, name, {\r\n    configurable,\r\n    enumerable,\r\n    get: function() {\r\n      return get.call(tar)\r\n    },\r\n    set: function(val) {\r\n      // 前置回调\r\n      val = before.reduce(function(pre, fn) {\r\n        return fn.call(tar, pre) || pre\r\n      }, val)\r\n      \r\n      set.call(tar, val)\r\n\r\n      // 后置回调\r\n      after.reduce(function(pre, fn) {\r\n        return fn.call(tar, pre) || pre\r\n      }, val)\r\n    }\r\n  })\r\n  \r\n  return { before, after }\r\n}\r\n\r\n// 从数组中删除某个元素\r\nfunction splice(arr, tar) {\r\n  let i = arr.indexOf(tar)\r\n  if (i != -1) {\r\n    arr.splice(i, 1)\r\n  }\r\n}\r\n\r\n/**\r\n * 劫持原型链属性并添加 hook function\r\n * @param {HTMLElement} tar\r\n * @param {String} name - 属性名\r\n * @param {Function} fn - hook function\r\n * @param {String} type - before/after  \r\n */\r\nexport function addHook(tar, name, fn, type = 'after') {\r\n  let { before, after } = hijackProperty(tar, name) || getHookCache(tar, name)\r\n  switch(type) {\r\n    case 'before':\r\n      splice(before, fn)\r\n      before.push(fn)\r\n      break\r\n    default:\r\n      splice(after, fn)\r\n      after.push(fn)\r\n      break\r\n  }\r\n}\r\n\r\n/**\r\n * 删除 hook function\r\n * @param {HTMLElement} tar\r\n * @param {String} name - 属性名\r\n * @param {Function} fn - hook function\r\n * @param {String} type - before/after  \r\n */\r\nexport function removeHook(tar, name, fn, type = 'after') {\r\n  let { before, after } = getHookCache(tar, name)\r\n  switch(type) {\r\n    case 'before':\r\n      splice(before, fn)\r\n      break\r\n    default:\r\n      splice(after, fn)\r\n      break\r\n  }\r\n}"],"names":["createPropertyDescriptor","data","configurable","enumerable","get","set","val","getHookName","name","before","after","hooks","WeakMap","getHookCache","tar","has","hook","hijackProperty","Reflect","getOwnPropertyDescriptor","__proto__","defineProperty","call","reduce","pre","fn","splice","arr","i","indexOf","addHook","type","push","removeHook"],"mappings":"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"}